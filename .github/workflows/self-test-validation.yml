name: Self Test - validation workflows

on:
  push:
    branches: [main]
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  test-validation-workflow:
    uses: ./.github/workflows/validation.yml
    with:
      working_directory: "./tests/valid-app"
      post_install_script: "npx playwright install --with-deps"

  test-audit-invalid:
    name: Test - Invalid Node npm audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up node and deps
        uses: ./actions/setup
        with:
          working_directory: "./tests/audit-invalid"

      - name: Run npm audit (invalid config)
        id: audit
        uses: ./actions/audit
        continue-on-error: true
        with:
          working_directory: "./tests/audit-invalid"

      - name: Assert failure
        run: |
          if [ "${{ steps.audit.outputs.npm_audit_exit_code }}" -eq 0 ]; then
            echo "Expected npm audit to fail but it succeeded."
            exit 1
          fi

  test-lint-invalid:
    name: Test - Invalid Node npm lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up node and deps
        uses: ./actions/setup
        with:
          working_directory: "./tests/lint-invalid"

      - name: Run npm lint (invalid config)
        id: lint
        uses: ./actions/lint
        continue-on-error: true
        with:
          working_directory: "./tests/lint-invalid"

      - name: Assert failure
        run: |
          if [ "${{ steps.lint.outputs.npm_lint_exit_code }}" -eq 0 ]; then
            echo "Expected npm lint to fail but it succeeded."
            exit 1
          fi
